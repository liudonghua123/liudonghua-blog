{"summary":"<p>昨天看到消息Google发布了Android 5.1(Codename还是Lollipop，说明变化不大)，但是上网搜了一下只有factory image，这样刷的话会清除手机上原来的所有数据，而且我原来装的系统也没有被我修改过，所以最好还是通过OTA升级，但OTA升级在国内一般都比较慢，而且由于Google在国内不稳定或根本就无法访问，所以最好还是手动下载OTA升级。</p>\n<a id=\"more\"></a>\n<p>但找了很久都没找到N5的OTA下载链接，可能过几天就会有了。</p>\n<p>所以就想看一下Android“系统更新”模块是怎样实现的，这样或许就可以直接从代码里找出下载链接</p>\n<p>在Settings的源码下一步一步搜索，最终找到这里<br>res\\xml\\device_info_settings.xml</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">&lt;!-- System update settings - launches activity --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">PreferenceScreen</span> <span class=\"attr\">android:key</span>=<span class=\"string\">\"system_update_settings\"</span></span></span><br><span class=\"line\"><span class=\"tag\">        <span class=\"attr\">android:title</span>=<span class=\"string\">\"@string/system_update_settings_list_item_title\"</span></span></span><br><span class=\"line\"><span class=\"tag\">        <span class=\"attr\">android:summary</span>=<span class=\"string\">\"@string/system_update_settings_list_item_summary\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">intent</span> <span class=\"attr\">android:action</span>=<span class=\"string\">\"android.settings.SYSTEM_UPDATE_SETTINGS\"</span> /&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">PreferenceScreen</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>也就是说在设置里点了系统更新之后，只会发一个”android.settings.SYSTEM_UPDATE_SETTINGS”的广播，然后由注册了这个广播的组件来处理。<br>GoogleServicesFramework的AndroidManifest.xml有</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?xml version=\"1.0\" encoding=\"utf-8\" standalone=\"no\"?&gt;</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">manifest</span> <span class=\"attr\">xmlns:android</span>=<span class=\"string\">\"http://schemas.android.com/apk/res/android\"</span> <span class=\"attr\">android:sharedUserId</span>=<span class=\"string\">\"com.google.uid.shared\"</span> <span class=\"attr\">package</span>=<span class=\"string\">\"com.google.android.gsf\"</span> <span class=\"attr\">platformBuildVersionCode</span>=<span class=\"string\">\"21\"</span> <span class=\"attr\">platformBuildVersionName</span>=<span class=\"string\">\"5.0.1-1602158\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">application</span>&gt;</span></span><br><span class=\"line\">        ......</span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">activity</span> <span class=\"attr\">android:enabled</span>=<span class=\"string\">\"false\"</span> <span class=\"attr\">android:hardwareAccelerated</span>=<span class=\"string\">\"true\"</span> <span class=\"attr\">android:label</span>=<span class=\"string\">\"@string/system_update_activity_name\"</span> <span class=\"attr\">android:launchMode</span>=<span class=\"string\">\"singleTop\"</span> <span class=\"attr\">android:name</span>=<span class=\"string\">\".update.SystemUpdateActivity\"</span> <span class=\"attr\">android:theme</span>=<span class=\"string\">\"@android:style/Theme.Holo.NoActionBar\"</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">intent-filter</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">action</span> <span class=\"attr\">android:name</span>=<span class=\"string\">\"android.settings.SYSTEM_UPDATE_SETTINGS\"</span>/&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">category</span> <span class=\"attr\">android:name</span>=<span class=\"string\">\"android.intent.category.DEFAULT\"</span>/&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;/<span class=\"name\">intent-filter</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">activity</span>&gt;</span></span><br><span class=\"line\">        ......</span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">application</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>对于N5来说，就是由GoogleServicesFramework中的com.google.android.gsf.update.SystemUpdateActivity来处理，由于这部分源码不是开源的，反编译代码错综复杂，现在暂时还没找到。</p>\n<p>不过后来搜索以前N5的OTA下载地址，网址一般都是<a href=\"http://android.clients.google.com/packages/ota/**google_hammerhead**/**some_hash**.signed-hammerhead-**new_build_name**-from-**old_build_name**.**some_other_hash**.zip\" target=\"_blank\" rel=\"noopener\">http://android.clients.google.com/packages/ota/**google_hammerhead**/**some_hash**.signed-hammerhead-**new_build_name**-from-**old_build_name**.**some_other_hash**.zip</a><br>如Nexus 5 (hammerhead) LRX21O to LRX22C<br><a href=\"http://android.clients.google.com/packages/ota/**google_hammerhead**/**785a2f7af3718dba7e569decde8b6c4dc476a309**.signed-hammerhead-**LRX22C**-from-**LRX21O**.**785a2f7a**.zip\" target=\"_blank\" rel=\"noopener\">http://android.clients.google.com/packages/ota/**google_hammerhead**/**785a2f7af3718dba7e569decde8b6c4dc476a309**.signed-hammerhead-**LRX22C**-from-**LRX21O**.**785a2f7a**.zip</a></p>\n<p><del>这样在Google中搜索”google_hammerhead LMY47D LRX22C”关键字，找到如下的下载链接</del><br><del> <a href=\"http://android.clients.google.com/packages/ota/google_hammerhead/683daf65f4daf477b5f42f565f42f42f5681b03f41.signed-hammerhead-1234567890123LMY47D-from-LRX22C.683daf65.zip\" target=\"_blank\" rel=\"noopener\">http://android.clients.google.com/packages/ota/google_hammerhead/683daf65f4daf477b5f42f565f42f42f5681b03f41.signed-hammerhead-1234567890123LMY47D-from-LRX22C.683daf65.zip</a></del><br><del> 现在正在验证一下是不是可以下载。<br></del>已证实上面地址是假的，在EC2服务器上下载时404</p>\n<p>2015/3/21 更新：正确的下载地址  <a href=\"http://android.clients.google.com/packages/ota/google_hammerhead/e16268c5a3df75a65054ab258d7d615288b7e3b4.signed-hammerhead-ota-LMY47D-from-LRX22C-radio-restricted.zip\" target=\"_blank\" rel=\"noopener\">http://android.clients.google.com/packages/ota/google_hammerhead/e16268c5a3df75a65054ab258d7d615288b7e3b4.signed-hammerhead-ota-LMY47D-from-LRX22C-radio-restricted.zip</a> ， 详见<a href=\"http://www.droid-life.com/2015/03/11/download-android-5-1-ota-updates-for-nexus-devices-4-5-6-7-9-10/\" target=\"_blank\" rel=\"noopener\">Download: Android 5.1 OTA Updates for Nexus Devices (Updated)</a></p>\n"}