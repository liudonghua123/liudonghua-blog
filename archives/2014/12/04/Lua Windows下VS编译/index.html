<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="lua,vs," />





  <link rel="alternate" href="/atom.xml" title="liudonghua's blog" type="application/atom+xml" />






<meta name="description" content="Lua是一门短小精炼，可扩展性很强的脚本语言，相比Python、Ruby等其他脚本语言，虽然本身核心库提供的功能有限，但运行效率据说是最好的，在一些游戏引擎中被使用，以被人了解，很多人提到lua就会联想到游戏引擎，其实lua还有很多非常广泛的用途，主要用在一些嵌入式、对性能要求很高、资源很有限（KB级内存）的领域。">
<meta name="keywords" content="lua,vs">
<meta property="og:type" content="article">
<meta property="og:title" content="Lua Windows下VS编译">
<meta property="og:url" content="http://65031141.ynu.edu.cn/archives/2014/12/04/Lua Windows下VS编译/index.html">
<meta property="og:site_name" content="liudonghua&#39;s blog">
<meta property="og:description" content="Lua是一门短小精炼，可扩展性很强的脚本语言，相比Python、Ruby等其他脚本语言，虽然本身核心库提供的功能有限，但运行效率据说是最好的，在一些游戏引擎中被使用，以被人了解，很多人提到lua就会联想到游戏引擎，其实lua还有很多非常广泛的用途，主要用在一些嵌入式、对性能要求很高、资源很有限（KB级内存）的领域。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://65031141.ynu.edu.cn/resources/2014/12/lua_DLUA_BUILD_AS_DLL.png">
<meta property="og:image" content="http://65031141.ynu.edu.cn/resources/2014/12/lua_project_compile_command_line.png">
<meta property="og:image" content="http://65031141.ynu.edu.cn/resources/2014/12/lua_project_dependence_references_settings.png">
<meta property="og:updated_time" content="2017-12-29T06:07:17.104Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Lua Windows下VS编译">
<meta name="twitter:description" content="Lua是一门短小精炼，可扩展性很强的脚本语言，相比Python、Ruby等其他脚本语言，虽然本身核心库提供的功能有限，但运行效率据说是最好的，在一些游戏引擎中被使用，以被人了解，很多人提到lua就会联想到游戏引擎，其实lua还有很多非常广泛的用途，主要用在一些嵌入式、对性能要求很高、资源很有限（KB级内存）的领域。">
<meta name="twitter:image" content="http://65031141.ynu.edu.cn/resources/2014/12/lua_DLUA_BUILD_AS_DLL.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://65031141.ynu.edu.cn/archives/2014/12/04/Lua Windows下VS编译/"/>





  <title>Lua Windows下VS编译 | liudonghua's blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">liudonghua's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">The beauty of life is its rich and colorful, to make life interesting, constantly enrich it.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://65031141.ynu.edu.cn/archives/2014/12/04/Lua Windows下VS编译/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Donghua Liu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="liudonghua's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Lua Windows下VS编译</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-12-04T07:17:28+00:00">
                2014-12-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/学习/" itemprop="url" rel="index">
                    <span itemprop="name">学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>Lua是一门短小精炼，可扩展性很强的脚本语言，相比Python、Ruby等其他脚本语言，虽然本身核心库提供的功能有限，但运行效率据说是最好的，在一些游戏引擎中被使用，以被人了解，很多人提到lua就会联想到游戏引擎，其实lua还有很多非常广泛的用途，主要用在一些嵌入式、对性能要求很高、资源很有限（KB级内存）的领域。</p>
<a id="more"></a>
<p>Linux、Mac等类Unix下编译安装lua都非常方便，wget源码之后，configure、make、make install即可搞定，但Windows下就不是很方便，虽然可以在Cgywin、MinGW等环境中使用Windows版的gcc、g++编译，不但麻烦，而且使用luarocks安装第三方需要编译的库时由于使用VS的cl、link等编译、链接会导致无法正确链接之前用其他编译器、链接器生成的dll或lib。所以最好的方式还是使用Windows原生的编译器编译，其过程步骤如下（我使用的是VS2013，其他版本大致类似）</p>
<ol>
<li><p>新建一个Win32控制台项目，如lua52（默认也会创建一个lua的解决方案，解决方案下可包括多个项目），Application Settings中选择DLL及选中Empty project</p>
</li>
<li><p>添加源码src下的<em>.h,</em>.hpp头文件到Header Files，添加*.c（除lua.c\luac.c）到Source Files</p>
</li>
<li><p>最重要的一步，项目属性中Configuration Properties - C/C++ - Command Line的Additional Options中添加<strong>/DLUA_BUILD_AS_DLL</strong> /D _CRT_SECURE_NO_WARNINGS，这里的/DLUA_BUILD_AS_DLL是必须的（因为在VS里编译动态库时必须要用<strong>declspec(dllexport)、</strong>declspec(dllimport)，而lua.h中所有的待导出函数都有LUA_API，再查看其宏定义位置就可找到luaconf.h中的声明，见下图），如果没有，虽然可以编译出DLL，但没有对应的LIB，而其他可执行项目链接时不管是动态链接、静态链接都是链接到LIB的，区别是如果是动态链接，链接到LIB后再由LIB链接DLL，静态链接就直接链接LIB结束；/D _CRT_SECURE_NO_WARNINGS是避免很多控制台编译警告。<br><a href="/resources/2014/12/lua_DLUA_BUILD_AS_DLL.png"><img src="/resources/2014/12/lua_DLUA_BUILD_AS_DLL.png" alt="lua_DLUA_BUILD_AS_DLL"></a><br><a href="/resources/2014/12/lua_project_compile_command_line.png"><img src="/resources/2014/12/lua_project_compile_command_line.png" alt="lua_project_compile_command_line"></a></p>
</li>
<li><p>然后再在这个解决方案下新建Win32控制台项目，如lua，Application Settings中选择Console Application及选中Empty project</p>
</li>
<li><p>在lua项目属性中的设置项目依赖，即可执行项目lua依赖动态库项目lua52，如下图所示，然后在Configuration Properties - C/C++ - General的Additional Include Directories中添加源码src路径<br><a href="/resources/2014/12/lua_project_dependence_references_settings.png"><img src="/resources/2014/12/lua_project_dependence_references_settings.png" alt="lua_project_dependence_references_settings"></a></p>
</li>
<li><p>添加lua.c到Source Files中<br>这样编译解决方案时就可以编译出DLL、LIB、EXE等文件了</p>
</li>
<li><p>luac和lua操作类似</p>
</li>
</ol>
<p>注：动态库编译出的lib是<a href="http://en.wikipedia.org/wiki/Dynamic-link_library#Import_libraries" target="_blank" rel="noopener">import libraries</a>，静态库编译出的lib才是static/share libraries</p>
<blockquote>
<h3 id="Import-libraries"><a href="#Import-libraries" class="headerlink" title="Import libraries"></a><span id="Import_libraries" class="mw-headline">Import libraries</span></h3><p>Like static libraries, import libraries for DLLs are noted by the .lib file extension. For example, <a href="http://en.wikipedia.org/wiki/Kernel32.dll" title="Kernel32.dll" target="_blank" rel="noopener">kernel32.dll</a>, the primary dynamic library for Windows’ base functions such as file creation and memory management, is linked via kernel32.lib.</p>
<p>Linking to dynamic libraries is usually handled by linking to an import library when building or linking to create an executable file. The created executable then contains an import address table (IAT) by which all DLL function calls are referenced (each referenced DLL function contains its own entry in the IAT). At run-time, the IAT is filled with appropriate addresses that point directly to a function in the separately loaded DLL.<br>其实lua代码写的很规范，程序也不是很大，可以深入分析学习以提高自己的C/C++编程能力，源码目录中只包括GNU makefile，不能使用VS的nmake，不过写一个跨平台的cmake应该不难。</p>
</blockquote>
<p>参考资料</p>
<ol>
<li><a href="http://msdn.microsoft.com/en-us/library/ms235636.aspx" target="_blank" rel="noopener">Walkthrough: Creating and Using a Dynamic Link Library (C++)</a></li>
<li><a href="http://www.codeproject.com/Articles/85391/Microsoft-Visual-C-Static-and-Dynamic-Libraries" target="_blank" rel="noopener">Microsoft Visual C++ Static and Dynamic Libraries</a></li>
<li><a href="http://msdn.microsoft.com/en-us/library/ms235639.aspx" target="_blank" rel="noopener">Walkthrough: Compiling a Native C++ Program on the Command Line</a></li>
<li><a href="http://www.cnblogs.com/junchu25/p/3626280.html" target="_blank" rel="noopener">Windows下Visual Studio 2013编译Lua 5.2.3</a></li>
<li><a href="http://z1y1m1.blog.163.com/blog/static/518373272014322102138399/" target="_blank" rel="noopener">windows下编译lua 5.2.x</a></li>
<li><a href="http://sourceforge.net/projects/luabinaries/" target="_blank" rel="noopener">LuaBinaries</a></li>
<li><a href="http://msdn.microsoft.com/en-us/library/3y1sfaz2.aspx" target="_blank" rel="noopener">dllexport, dllimport</a></li>
</ol>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/lua/" rel="tag"># lua</a>
          
            <a href="/tags/vs/" rel="tag"># vs</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/archives/2014/12/03/使用代理下载或更新Android源码/" rel="next" title="使用代理下载或更新Android源码">
                <i class="fa fa-chevron-left"></i> 使用代理下载或更新Android源码
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/archives/2014/12/05/Android 5.0源码编译tcpdump/" rel="prev" title="Android 5.0源码编译tcpdump">
                Android 5.0源码编译tcpdump <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Donghua Liu</p>
              <p class="site-description motion-element" itemprop="description">This is my blog site</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">71</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">144</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Import-libraries"><span class="nav-number">1.</span> <span class="nav-text">Import libraries</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Donghua Liu</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
