{"summary":"<p>之前我写过一篇文章”<a href=\"http://202.203.209.55:8080/?p=372\" target=\"_blank\" rel=\"noopener\">非Android源码中编译tcpdump</a>“，今天我终于使用AWS EC2作为代理服务器，完整的更新下载了Android源码（更新后，我的.repo居然有42G，checkout之后的纯代码有大概15G，Android源码也是越来越大了！一不小心免费的AWS的流量就超了7G多，$1.5就没了），所以就想在Android源码中编译tcpdump，体会原汁原味。以下记录我编译的一些过程。</p>\n<a id=\"more\"></a>\n<ol>\n<li>首先整个源码编译一遍，我使用make -j8，大概两小时完成</li>\n<li><p>cd到external/tcpdump，修改Android.mk，让编译出的tcpdump可以在Android 5.0上运行</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">liudonghua@liudonghua-Ubuntu:~/android$ cd external/tcpdump/</span><br><span class=\"line\">liudonghua@liudonghua-Ubuntu:~/android/external/tcpdump$ git diff</span><br><span class=\"line\">diff --git a/Android.mk b/Android.mk</span><br><span class=\"line\">index 348d8b0..8dc7a4e 100644</span><br><span class=\"line\">--- a/Android.mk</span><br><span class=\"line\">+++ b/Android.mk</span><br><span class=\"line\">@@ -38,6 +38,9 @@ LOCAL_SRC_FILES:=\\</span><br><span class=\"line\"></span><br><span class=\"line\"> LOCAL_CFLAGS := -O2 -g</span><br><span class=\"line\"> LOCAL_CFLAGS += -DHAVE_CONFIG_H -D_U_=\"__attribute__((unused))\"</span><br><span class=\"line\">+LOCAL_CFLAGS += -pie -fPIE</span><br><span class=\"line\">+</span><br><span class=\"line\">+LOCAL_LDFLAGS := -pie -fPIE</span><br><span class=\"line\"></span><br><span class=\"line\"> LOCAL_C_INCLUDES += \\</span><br><span class=\"line\">        $(LOCAL_PATH)/missing\\</span><br><span class=\"line\">liudonghua@liudonghua-Ubuntu:~/android/external/tcpdump$</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>执行mm，后面的编译过程如下</p>\n</li>\n</ol>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">liudonghua@liudonghua-Ubuntu:~/android/external/tcpdump$ mm</span><br><span class=\"line\">============================================</span><br><span class=\"line\">PLATFORM_VERSION_CODENAME=REL</span><br><span class=\"line\">PLATFORM_VERSION=5.0.50.50.50.50</span><br><span class=\"line\">TARGET_PRODUCT=aosp_hammerhead</span><br><span class=\"line\">TARGET_BUILD_VARIANT=userdebug</span><br><span class=\"line\">TARGET_BUILD_TYPE=release</span><br><span class=\"line\">TARGET_BUILD_APPS=</span><br><span class=\"line\">TARGET_ARCH=arm</span><br><span class=\"line\">TARGET_ARCH_VARIANT=armv7-a-neon</span><br><span class=\"line\">TARGET_CPU_VARIANT=krait</span><br><span class=\"line\">TARGET_2ND_ARCH=</span><br><span class=\"line\">TARGET_2ND_ARCH_VARIANT=</span><br><span class=\"line\">TARGET_2ND_CPU_VARIANT=</span><br><span class=\"line\">HOST_ARCH=x86_64</span><br><span class=\"line\">HOST_OS=linux</span><br><span class=\"line\">HOST_OS_EXTRA=Linux-3.13.0-39-generic-x86_64-with-Ubuntu-14.04-trusty</span><br><span class=\"line\">HOST_BUILD_TYPE=release</span><br><span class=\"line\">BUILD_ID=AOSP</span><br><span class=\"line\">OUT_DIR=out</span><br><span class=\"line\">============================================</span><br><span class=\"line\">PRODUCT_COPY_FILES device/generic/goldfish/data/etc/apns-conf.xml:system/etc/apns-conf.xml ignored.</span><br><span class=\"line\">No private recovery resources for TARGET_DEVICE hammerhead</span><br><span class=\"line\">make: Entering directory `/home/liudonghua/android'</span><br><span class=\"line\">make: *** No rule to make target `out/target/product/hammerhead/obj/STATIC_LIBRARIES/libpcap_intermediates/export_includes', needed by `out/target/product/hammerhead/obj/EXECUTABLES/tcpdump_intermediates/import_includes'.  Stop.</span><br><span class=\"line\">make: Leaving directory `/home/liudonghua/android'</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span>### make failed to build some targets (1 seconds) ####</span><br><span class=\"line\"></span><br><span class=\"line\">liudonghua@liudonghua-Ubuntu:~/android/external/tcpdump$cd ../libpcap</span><br><span class=\"line\">/home/liudonghua/android/external/libpcap</span><br><span class=\"line\">liudonghua@liudonghua-Ubuntu:~/android/external/libpcap$ mm</span><br><span class=\"line\">.................................</span><br><span class=\"line\">Export includes file: external/libpcap/Android.mk -- out/target/product/hammerhead/obj/STATIC_LIBRARIES/libpcap_intermediates/export_includes</span><br><span class=\"line\">target StaticLib: libpcap (out/target/product/hammerhead/obj/STATIC_LIBRARIES/libpcap_intermediates/libpcap.a)</span><br><span class=\"line\">make: Leaving directory `/home/liudonghua/android'</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span>### make completed successfully (9 seconds) ####</span><br><span class=\"line\"></span><br><span class=\"line\">liudonghua@liudonghua-Ubuntu:~/android/external/libpcap$</span><br><span class=\"line\">liudonghua@liudonghua-Ubuntu:~/android/external/libpcap$ cd -</span><br><span class=\"line\">/home/liudonghua/android/external/tcpdump</span><br><span class=\"line\">liudonghua@liudonghua-Ubuntu:~/android/external/tcpdump$ mm</span><br><span class=\"line\">.................................</span><br><span class=\"line\">target Executable: tcpdump (out/target/product/hammerhead/obj/EXECUTABLES/tcpdump_intermediates/LINKED/tcpdump)</span><br><span class=\"line\">target Symbolic: tcpdump (out/target/product/hammerhead/symbols/system/xbin/tcpdump)</span><br><span class=\"line\">Export includes file: external/tcpdump/Android.mk -- out/target/product/hammerhead/obj/EXECUTABLES/tcpdump_intermediates/export_includes</span><br><span class=\"line\">target Strip: tcpdump (out/target/product/hammerhead/obj/EXECUTABLES/tcpdump_intermediates/tcpdump)</span><br><span class=\"line\">Install: out/target/product/hammerhead/system/xbin/tcpdump</span><br><span class=\"line\">make: Leaving directory `/home/liudonghua/android'</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span>### make completed successfully (34 seconds) ####</span><br><span class=\"line\"></span><br><span class=\"line\">liudonghua@liudonghua-Ubuntu:~/android/external/tcpdump$</span><br><span class=\"line\">liudonghua@liudonghua-Ubuntu:~/android$ file out/target/product/hammerhead/obj/EXECUTABLES/tcpdump_intermediates/tcpdump</span><br><span class=\"line\">out/target/product/hammerhead/obj/EXECUTABLES/tcpdump_intermediates/tcpdump: ELF 32-bit LSB  shared object, ARM, EABI5 version 1 (SYSV), dynamically linked (uses shared libs), stripped</span><br></pre></td></tr></table></figure>\n<p>如果之前没有源码编译过会mm libpcap时会有如下错误<br><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">liudonghua@liudonghua-Ubuntu:~/android/external/libpcap$ mm</span><br><span class=\"line\">============================================</span><br><span class=\"line\">PLATFORM_VERSION_CODENAME=REL</span><br><span class=\"line\">PLATFORM_VERSION=5.0.50.50.50.50</span><br><span class=\"line\">TARGET_PRODUCT=aosp_arm</span><br><span class=\"line\">TARGET_BUILD_VARIANT=eng</span><br><span class=\"line\">TARGET_BUILD_TYPE=release</span><br><span class=\"line\">TARGET_BUILD_APPS=</span><br><span class=\"line\">TARGET_ARCH=arm</span><br><span class=\"line\">TARGET_ARCH_VARIANT=armv7-a</span><br><span class=\"line\">TARGET_CPU_VARIANT=generic</span><br><span class=\"line\">TARGET_2ND_ARCH=</span><br><span class=\"line\">TARGET_2ND_ARCH_VARIANT=</span><br><span class=\"line\">TARGET_2ND_CPU_VARIANT=</span><br><span class=\"line\">HOST_ARCH=x86_64</span><br><span class=\"line\">HOST_OS=linux</span><br><span class=\"line\">HOST_OS_EXTRA=Linux-3.13.0-39-generic-x86_64-with-Ubuntu-14.04-trusty</span><br><span class=\"line\">HOST_BUILD_TYPE=release</span><br><span class=\"line\">BUILD_ID=AOSP</span><br><span class=\"line\">OUT_DIR=out</span><br><span class=\"line\">============================================</span><br><span class=\"line\">make: Entering directory `/home/liudonghua/android'</span><br><span class=\"line\">make: *** No rule to make target `out/target/product/generic/obj/SHARED_LIBRARIES/libc++_intermediates/export_includes', needed by `out/target/product/generic/obj/STATIC_LIBRARIES/libpcap_intermediates/import_includes'.  Stop.</span><br><span class=\"line\">make: Leaving directory `/home/liudonghua/android'</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span>### make failed to build some targets (1 seconds) ####</span><br><span class=\"line\"></span><br><span class=\"line\">liudonghua@liudonghua-Ubuntu:~/android/external/libpcap$</span><br></pre></td></tr></table></figure></p>\n<p>其实仔细看m\\mm\\mmm的来源，我们完全可以用mma\\mmma来代替解决编译依赖关系<br><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">liudonghua@liudonghua-Ubuntu:~/android$ head -n 20 build/envsetup.sh </span><br><span class=\"line\">function hmm() &#123;</span><br><span class=\"line\">cat &lt;&lt;EOF</span><br><span class=\"line\">Invoke \". build/envsetup.sh\" from your shell to add the following functions to your environment:</span><br><span class=\"line\">- lunch:   lunch &lt;product_name&gt;-&lt;build_variant&gt;</span><br><span class=\"line\">- tapas:   tapas [&lt;App1&gt; &lt;App2&gt; ...] [arm|x86|mips|armv5|arm64|x86_64|mips64] [eng|userdebug|user]</span><br><span class=\"line\">- croot:   Changes directory to the top of the tree.</span><br><span class=\"line\">- m:       Makes from the top of the tree.</span><br><span class=\"line\">- mm:      Builds all of the modules in the current directory, but not their dependencies.</span><br><span class=\"line\">- mmm:     Builds all of the modules in the supplied directories, but not their dependencies.</span><br><span class=\"line\">           To limit the modules being built use the syntax: mmm dir/:target1,target2.</span><br><span class=\"line\">- mma:     Builds all of the modules in the current directory, and their dependencies.</span><br><span class=\"line\">- mmma:    Builds all of the modules in the supplied directories, and their dependencies.</span><br><span class=\"line\">- cgrep:   Greps on all local C/C++ files.</span><br><span class=\"line\">- ggrep:   Greps on all local Gradle files.</span><br><span class=\"line\">- jgrep:   Greps on all local Java files.</span><br><span class=\"line\">- resgrep: Greps on all local res/*.xml files.</span><br><span class=\"line\">- sgrep:   Greps on all local source files.</span><br><span class=\"line\">- godir:   Go to the directory containing a file.</span><br><span class=\"line\"></span><br><span class=\"line\">Look at the source to view more functions. The complete list is:</span><br><span class=\"line\">liudonghua@liudonghua-Ubuntu:~/android$</span><br></pre></td></tr></table></figure></p>\n"}