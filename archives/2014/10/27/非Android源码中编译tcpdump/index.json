{"summary":"<p>之前一篇<a href=\"http://202.203.209.55:8080/?p=367\" target=\"_blank\" rel=\"noopener\">文章</a>提到的<a href=\"http://www.strazzere.com/android/tcpdump\" target=\"_blank\" rel=\"noopener\">以前下载的tcpdump</a>在Android 5.0上运行出错，并且给出了解决办法，即编译时添加”-fPIE -pie”参数，简单的做法就是在Android源码中的external/tcpdump/Android.mk中添加这个参数，但如果没有下载Android源码，使用NDK可以编译出来吗？</p>\n<a id=\"more\"></a>\n<p>我测试了一下，因为Android源码里的tcpdump的Android.mk涉及到很多其他库的头文件、静态库、动态库等，如下所示的是tcpdump中Android.mk中的部分内容</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">LOCAL_C_INCLUDES += \\</span><br><span class=\"line\"><span class=\"meta\">$</span><span class=\"bash\">(LOCAL_PATH)/missing\\</span></span><br><span class=\"line\">external/openssl/include\\</span><br><span class=\"line\">external/libpcap</span><br><span class=\"line\"></span><br><span class=\"line\">LOCAL_SHARED_LIBRARIES += libssl libcrypto</span><br><span class=\"line\"></span><br><span class=\"line\">LOCAL_STATIC_LIBRARIES += libpcap</span><br></pre></td></tr></table></figure>\n<p>而且libpcap、openssl也涉及到其他库，即有多重依赖关系，直接使用ndk-build非常困难，后来查阅资料在<a href=\"http://omappedia.org/wiki/USB_Sniffing_with_tcpdump\" target=\"_blank\" rel=\"noopener\">这里</a>找到一些有用信息——直接使用ndk-build内部的交叉编译器(arm-linux-androideabi-*)编译，按照文章里提到的方式去编译，大致命令如下（在Windows平台上交叉编译很不方便，以下是在Linux下操作的）</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir ~/tcpdump</span><br><span class=\"line\">cd ~/tcpdump</span><br><span class=\"line\">wget http://www.tcpdump.org/release/libpcap-1.6.2.tar.gz</span><br><span class=\"line\">wget http://www.tcpdump.org/release/tcpdump-4.6.2.tar.gz</span><br><span class=\"line\">tar -xzvf libpcap-1.6.2.tar.gz</span><br><span class=\"line\">tar -xzvf tcpdump-4.6.2.tar.gz</span><br><span class=\"line\">mkdir toolchain</span><br><span class=\"line\"><span class=\"meta\">%</span><span class=\"bash\">NDK_HOME%/build/tools/make-standalone-toolchain.sh --platform=android-21 --install-dir=~/tcpdump/toolchain</span></span><br><span class=\"line\">export PATH=~/tcpdump/toolchain/bin:$PATH</span><br><span class=\"line\">export CC=arm-linux-androideabi-gcc</span><br><span class=\"line\">export RANLIB=arm-linux-androideabi-ranlib</span><br><span class=\"line\">export AR=arm-linux-androideabi-ar</span><br><span class=\"line\">export LD=arm-linux-androideabi-ld</span><br><span class=\"line\">cd libpcap-1.6.2</span><br><span class=\"line\">./configure --host=arm-linux --with-pcap=~/tcpdump/libpcap-1.6.2 ac_cv_linux_vers=2</span><br><span class=\"line\">make</span><br><span class=\"line\">cd ../tcpdump-4.6.2</span><br><span class=\"line\">sed -i\".bak\" \"s/setprotoent/\\/\\/setprotoent/g\" print-isakmp.c</span><br><span class=\"line\">sed -i\".bak\" \"s/endprotoent/\\/\\/endprotoent/g\" print-isakmp.c</span><br><span class=\"line\">./configure --host=arm-linux --with-pcap=linux --with-crypto=no ac_cv_linux_vers=2 --disable-ipv6</span><br><span class=\"line\">vi Makefile # 在CFLAGS、LDFLAGS中添加\"-fPIE -pie\"</span><br><span class=\"line\">make # 或者不用做上面那一步，使用make CFLAGS=\"-DNBBY=8 -fPIE -pie\"</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"> 最后编译完之后在根目录下即有tcpdump</span></span><br><span class=\"line\">file tcpdump</span><br><span class=\"line\">tcpdump: ELF 32-bit LSB  shared object, ARM, EABI5 version 1 (SYSV), dynamically linked (uses shared libs), not stripped</span><br></pre></td></tr></table></figure>\n<p>其中在tcpdump-4.6.2中configure时需要添加”–disable-ipv6”，否则会提示</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">checking whether to enable ipv6... yes</span><br><span class=\"line\">checking ipv6 stack type... linux-libinet6</span><br><span class=\"line\">You do not have inet6 library, using libc</span><br><span class=\"line\">checking for library containing getaddrinfo... none required</span><br><span class=\"line\">checking getaddrinfo bug... buggy</span><br><span class=\"line\">Fatal: You must get working getaddrinfo() function.</span><br><span class=\"line\">       or you can specify \"--disable-ipv6\".</span><br></pre></td></tr></table></figure>\n<p>但即使添加了也会有如下警告，但不影响后面的编译及tcpdump的正常使用</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">config.status: executing default-1 commands</span><br><span class=\"line\">configure: WARNING: unrecognized options: --with-pcap</span><br></pre></td></tr></table></figure>\n<p>接着就可以推送到手机中使用了</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">adb push tcpdump /sdcard/</span><br><span class=\"line\">adb shell</span><br><span class=\"line\">su</span><br><span class=\"line\">mount -o remount,rw /system</span><br><span class=\"line\">mv /sdcard/tcpdump /system/xbin/</span><br><span class=\"line\">chmod 4755 /system/xbin/tcpdump</span><br></pre></td></tr></table></figure>\n<p>但这样非root用户运行tcpdump还是会报如下错误，所以后面还是得su之后抓包</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tcpdump: Can't open netlink socket 13:Permission denied</span><br></pre></td></tr></table></figure>\n<p>这里是我编译的<a href=\"/resources/2014/10/tcpdump.zip\">tcpdump</a>，方便别人直接下载使用</p>\n"}