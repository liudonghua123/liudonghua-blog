{"summary":"<p>在Java中我们通常可能为了性能考虑，通过static设置一个全局的DateFormat，如下所示。</p>\n<a id=\"more\"></a>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Utils</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> DateFormat mDateTimeFormatter = <span class=\"keyword\">new</span> SimpleDateFormat(<span class=\"string\">\"yy-MM-dd HH:mm:ss\"</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> Date <span class=\"title\">parse</span><span class=\"params\">(String dateTimeString)</span> </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> mDateTimeFormatter.parse(dateTimeString);</span><br><span class=\"line\">\t\t&#125; <span class=\"keyword\">catch</span> (ParseException e) &#123;</span><br><span class=\"line\">\t\t\te.printStackTrace();</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">format</span><span class=\"params\">(Date dateTime)</span> </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> mDateTimeFormatter.format(dateTime);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>但我们忽略了一个很重要的地方，就是<a href=\"https://docs.oracle.com/javase/7/docs/api/java/text/SimpleDateFormat.html\" title=\"Date formats are not synchronized. It is recommended to create separate format instances for each thread. If multiple threads access a format concurrently, it must be synchronized externally.\" target=\"_blank\" rel=\"noopener\">SimpleDateFormat</a>并不是线程安全的（即non-thread-safe），Android版的<a href=\"http://developer.android.com/reference/java/text/SimpleDateFormat.html\" title=\"SimpleDateFormat is not thread-safe. Users should create a separate instance for each thread.\" target=\"_blank\" rel=\"noopener\">SimpleDateFormat</a>同样不是线程安全的，所以上面的代码是存在一定的问题，不过对于格式化日期时间使用很少或进程很少的情况下是很难发现这个问题。</p>\n<p>要正确使用格式化日期时间的方式可以有以下几种</p>\n<ol>\n<li>在每个方法中创建局部对象，每次调用都会创建，用完之后立刻垃圾回收掉，但这种方法有些资源浪费，没有合理复用资源，并且SimpleDateFormat也不是一个轻量级的对象，非常不推荐使用。</li>\n</ol>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> Date <span class=\"title\">parse</span><span class=\"params\">(String dateTimeString)</span> </span>&#123;</span><br><span class=\"line\">\tDateFormat mDateTimeFormatter = <span class=\"keyword\">new</span> SimpleDateFormat(<span class=\"string\">\"yy-MM-dd HH:mm:ss\"</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> mDateTimeFormatter.parse(dateTimeString);</span><br><span class=\"line\">\t&#125; <span class=\"keyword\">catch</span> (ParseException e) &#123;</span><br><span class=\"line\">\t\te.printStackTrace();</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">format</span><span class=\"params\">(Date dateTime)</span> </span>&#123;</span><br><span class=\"line\">\tDateFormat mDateTimeFormatter = <span class=\"keyword\">new</span> SimpleDateFormat(<span class=\"string\">\"yy-MM-dd HH:mm:ss\"</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> mDateTimeFormatter.format(dateTime);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ol>\n<li>在方法调用时使用synchronized同步块，如下图所示，这样但某一时刻同时又多个线程使用，则后面的线程会阻塞直到前面的使用完，这种方式可以节省资源，适用于线程不多，调用不频繁的情况。</li>\n</ol>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> Date <span class=\"title\">parse</span><span class=\"params\">(String dateTimeString)</span> </span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">synchronized</span> (mDateTimeFormatter) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> mDateTimeFormatter.parse(dateTimeString);</span><br><span class=\"line\">\t\t&#125; <span class=\"keyword\">catch</span> (ParseException e) &#123;</span><br><span class=\"line\">\t\t\te.printStackTrace();</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">format</span><span class=\"params\">(Date dateTime)</span> </span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">synchronized</span> (mDateTimeFormatter) &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> mDateTimeFormatter.format(dateTime);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ol>\n<li>使用<a href=\"https://docs.oracle.com/javase/7/docs/api/java/lang/ThreadLocal.html\" title=\"Each thread holds an implicit reference to its copy of a thread-local variable as long as the thread is alive and the ThreadLocal instance is accessible; after a thread goes away, all of its copies of thread-local instances are subject to garbage collection (unless other references to these copies exist).\" target=\"_blank\" rel=\"noopener\">ThreadLocal</a>对没有线程创建一份非线程安全的对象实例，这种方式比较优雅</li>\n</ol>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> ThreadLocal&lt;SimpleDateFormat&gt; mDateTimeFormatter = <span class=\"keyword\">new</span> ThreadLocal&lt;SimpleDateFormat&gt;() &#123;</span><br><span class=\"line\">\t<span class=\"function\"><span class=\"keyword\">protected</span> SimpleDateFormat <span class=\"title\">initialValue</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> <span class=\"keyword\">new</span> SimpleDateFormat(<span class=\"string\">\"yy-MM-dd HH:mm:ss\"</span>);</span><br><span class=\"line\">\t&#125;;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> Date <span class=\"title\">parse</span><span class=\"params\">(String dateTimeString)</span> </span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">return</span> mDateTimeFormatter.get().parse(dateTimeString);</span><br><span class=\"line\">\t&#125; <span class=\"keyword\">catch</span> (ParseException e) &#123;</span><br><span class=\"line\">\t\te.printStackTrace();</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"keyword\">null</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> String <span class=\"title\">format</span><span class=\"params\">(Date dateTime)</span> </span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> mDateTimeFormatter.get().format(dateTime);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>ThreadLocal的实现方式其实很直接，在每个Thread中都有一个map(ThreadLocalMap对象，对ThreadLocal是弱引用)</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Thead.java</span></span><br><span class=\"line\">    ThreadLocal.ThreadLocalMap threadLocals = <span class=\"keyword\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// ThreadLocal.java</span></span><br><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">ThreadLocalMap</span> </span>&#123;</span><br><span class=\"line\"><span class=\"keyword\">static</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Entry</span> <span class=\"keyword\">extends</span> <span class=\"title\">WeakReference</span>&lt;<span class=\"title\">ThreadLocal</span>&lt;?&gt;&gt; </span>&#123;</span><br><span class=\"line\">......</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\">ThreadLocalMap <span class=\"title\">getMap</span><span class=\"params\">(Thread t)</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> t.threadLocals;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> T <span class=\"title\">get</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        Thread t = Thread.currentThread();</span><br><span class=\"line\">        ThreadLocalMap map = getMap(t);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (map != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">            ThreadLocalMap.Entry e = map.getEntry(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (e != <span class=\"keyword\">null</span>) &#123;</span><br><span class=\"line\">                <span class=\"meta\">@SuppressWarnings</span>(<span class=\"string\">\"unchecked\"</span>)</span><br><span class=\"line\">                T result = (T)e.value;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> result;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> setInitialValue();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">void</span> <span class=\"title\">set</span><span class=\"params\">(T value)</span> </span>&#123;</span><br><span class=\"line\">        Thread t = Thread.currentThread();</span><br><span class=\"line\">        ThreadLocalMap map = getMap(t);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (map != <span class=\"keyword\">null</span>)</span><br><span class=\"line\">            map.set(<span class=\"keyword\">this</span>, value);</span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">            createMap(t, value);</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>但不恰当使用时也可能会出现内存泄漏，可以参考<a href=\"http://www.appneta.com/blog/introduction-to-javas-threadlocal-storage/\" title=\"First of all, the value object put into the ThreadLocal would not purge itself (garbage collected) if there are no more Strong references to it. Instead, the Weak reference is done on the thread instance, which means Java garbage collection would clean up the ThreadLocal map if the thread itself is not strongly referenced elsewhere.\" target=\"_blank\" rel=\"noopener\">A Painless Introduction to Java’s ThreadLocal Storage</a>，<a href=\"http://avasseur.blogspot.com/2003/11/threadlocal-and-memory-leaks.html\" target=\"_blank\" rel=\"noopener\">ThreadLocal and memory leaks</a> 。</p>\n<ol>\n<li>使用线程安全的DateFormat，如Commons Lang的<a href=\"https://commons.apache.org/proper/commons-lang/javadocs/api-2.6/org/apache/commons/lang/time/FastDateFormat.html\" title=\"FastDateFormat is a fast and thread-safe version of SimpleDateFormat.\" target=\"_blank\" rel=\"noopener\">FastDateFormat</a>，joda-time的<a href=\"http://joda-time.sourceforge.net/apidocs/org/joda/time/format/DateTimeFormat.html\" title=\"DateTimeFormat is thread-safe and immutable, and the formatters it returns are as well.\" target=\"_blank\" rel=\"noopener\">DateTimeFormat</a>，或者JDK8中的<a href=\"https://docs.oracle.com/javase/8/docs/api/java/time/format/DateTimeFormatter.html\" title=\"A formatter created from a pattern can be used as many times as necessary, it is immutable and is thread-safe.\" target=\"_blank\" rel=\"noopener\">DateTimeFormatter</a></li>\n</ol>\n<p>参考资料</p>\n<ol>\n<li><a href=\"http://stackoverflow.com/questions/6840803/simpledateformat-thread-safety\" target=\"_blank\" rel=\"noopener\">simpledateformat-thread-safety</a></li>\n</ol>\n"}