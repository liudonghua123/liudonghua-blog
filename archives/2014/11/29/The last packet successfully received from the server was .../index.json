{"summary":"<p>我之前部署的一个简单的web服务项目由于长时间没有访问，今天访问时数据没有显示出来，猜想可能是数据库访问模块出现了问题，查看日志，发现错误信息”<strong>The last packet successfully received from the server was</strong> 140,287,058 milliseconds ago.  The last packet sent successfully to the server was 140,287,058 milliseconds ago. <strong>is longer than the server configured value of ‘wait_timeout’</strong>. You should consider either expiring and/or testing connection validity before use in your application, <strong>increasing the server configured values</strong> for client timeouts, or using the Connector/J <strong>connection property ‘autoReconnect=true’</strong> to avoid this problem.”，这个错误信息之前使用数据库连接池时也遇到过，即如果服务器里的数据库连接长时间不用，超过mysql配置的”wait_timeout”（默认为28800s=8h），就会报这个错，从错误信息里就可以看到解决办法，延长”wait_timeout”，或配置”autoReconnect”，但这些方式都不是最好的方式——延长”wait_timeout”会浪费一些资源，配置”autoReconnect”（可以在jdbc<em>url中设置，如jdbc:mysql://localhost:3306/databasename?useUnicode=true&amp;characterEncoding=utf-8</em>&amp;_<strong>autoReconnect=true</strong>）只能在下次生效。最好的方式还是在捕获的SQLException中判断是否connection失效，如果是重新建立连接，然后再进行刚才的操作。</p>\n<a id=\"more\"></a>\n<p>以下是wait_timeout, autoReconnect的官方解释<br><a href=\"/resources/2014/11/mysql_sysvar_wait_timeout.png\"><img src=\"/resources/2014/11/mysql_sysvar_wait_timeout.png\" alt=\"mysql_sysvar_wait_timeout\"></a></p>\n<blockquote>\n<p><a href=\"http://dev.mysql.com/doc/connector-j/en/connector-j-reference-configuration-properties.html\" target=\"_blank\" rel=\"noopener\"><span class=\"strong\"><strong>autoReconnect</strong></span></a></p>\n<p>Should the driver try to re-establish stale and/or dead connections? If enabled the driver will throw an exception for a queries issued on a stale or dead connection, which belong to the current transaction, but will attempt reconnect before the next query issued on the connection in a new transaction. The use of this feature is not recommended, because it has side effects related to session state and data consistency when applications don’t handle SQLExceptions properly, and is only designed to be used when you are unable to configure your application to handle SQLExceptions resulting from dead and stale connections properly. Alternatively, as a last option, investigate setting the MySQL server variable “wait_timeout” to a high value, rather than the default of 8 hours.<br>以下是我修改的方式</p>\n</blockquote>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">......</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">public</span> <span class=\"keyword\">int</span> <span class=\"title\">addUser</span><span class=\"params\">(User user)</span> </span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">int</span> id = -<span class=\"number\">1</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// http://stackoverflow.com/questions/4246646/mysql-java-get-id-of-the-last-inserted-value-jdbc</span></span><br><span class=\"line\">\t\tPreparedStatement preparedStatement = connection</span><br><span class=\"line\">\t\t\t\t.prepareStatement(<span class=\"string\">\"insert into users(username,age,salary) values (?, ?, ? )\"</span>, Statement.RETURN_GENERATED_KEYS);</span><br><span class=\"line\">\t\tpreparedStatement.setString(<span class=\"number\">1</span>, user.getUsername());</span><br><span class=\"line\">\t\tpreparedStatement.setInt(<span class=\"number\">2</span>, user.getAge());</span><br><span class=\"line\">\t\tpreparedStatement.setDouble(<span class=\"number\">3</span>, user.getSalary());</span><br><span class=\"line\">\t\tpreparedStatement.executeUpdate();</span><br><span class=\"line\">\t\tResultSet rs = preparedStatement.getGeneratedKeys();</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (rs.next())&#123;</span><br><span class=\"line\">\t\t    id=rs.getInt(<span class=\"number\">1</span>);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125; <span class=\"keyword\">catch</span> (SQLException e) &#123;</span><br><span class=\"line\">\t\te.printStackTrace();</span><br><span class=\"line\">\t\t<span class=\"comment\">// try re-connect is needed</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span>(tryReconnectConnectionIfNeeded()) &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> addUser(user);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> id;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">......</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">private</span> <span class=\"keyword\">boolean</span> <span class=\"title\">tryReconnectConnectionIfNeeded</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\">// given 5 seconds timeout to reconnect</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span>(!connection.isValid(<span class=\"number\">5</span>)) &#123;</span><br><span class=\"line\">\t\t\tconnection = DatabaseUtil.reconnect();</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125; <span class=\"keyword\">catch</span> (SQLException e) &#123;</span><br><span class=\"line\">\t\te.printStackTrace();</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">......</span><br></pre></td></tr></table></figure>\n"}