---
title: 使用Python来处理文本
tags:
  - python
id: 747
categories:
  - 学习
date: 2015-04-29 20:28:38
---

今天一个朋友需要处理MovieLens的数据集，他想获取评分、用户性别、年龄、职业、电影分类这样的信息，但原始数据集中是分成三个文本文件（使用::分割的CSV文件）存储的，分别是movies.dat（MovieID::Title::Genres）、users.dat（UserID::Gender::Age::Occupation::Zip-code）、ratings.dat（UserID::MovieID::Rating::Timestamp）。<!--more-->

这个需求其实很简单的，本来想用熟悉的Java快速完成，但想到好久没用Python了，很多东西都忘了，所以就用Python帮他实现了一下，就当作回顾Python的知识
以下就是这部分代码，没有做什么优化（对这块了解的不是很深入），如果有什么建议大家可以告诉我！

[python]
#!/usr/bin/python

import os

__author__ = 'Liu.D.H'

class Movie(object):
    &quot;&quot;&quot;This is movie class which contains movie_id, title, and genres fields&quot;&quot;&quot;

    def __init__(self, movie_id, title, genres):
        self.movie_id = movie_id
        self.title = title
        self.genres = genres

class User(object):
    &quot;&quot;&quot;This is user class which contains user_id, gender, age, occupation and zipcode fields&quot;&quot;&quot;

    def __init__(self, user_id, gender, age, occupation, zipcode):
        self.user_id = user_id
        self.gender = gender
        self.age = age
        self.occupation = occupation
        self.zipcode = zipcode

class Rating(object):
    &quot;&quot;&quot;This is movie class which contains user_id, movie_id, rating and timestamp fields&quot;&quot;&quot;

    def __init__(self, user_id, movie_id, rating, timestamp):
        self.user_id = user_id
        self.movie_id = movie_id
        self.rating = rating
        self.timestamp = timestamp

def main():
    # define movie, user and rating storage
    movie_dict = {}
    user_dict = {}
    rating_list = []
    detailed_rating_list = []
    occupations = {0: &quot;other&quot;, 1: &quot;academic/educator&quot;, 2: &quot;artist&quot;, 3: &quot;clerical/admin&quot;, 4: &quot;college/grad student&quot;,
                   5: &quot;customer service&quot;, 6: &quot;doctor/health care&quot;, 7: &quot;executive/managerial&quot;, 8: &quot;farmer&quot;,
                   9: &quot;homemaker&quot;, 10: &quot;K-12 student&quot;, 11: &quot;lawyer&quot;, 12: &quot;programmer&quot;, 13: &quot;retired&quot;,
                   14: &quot;sales/marketing&quot;, 15: &quot;scientist&quot;, 16: &quot;self-employed&quot;, 17: &quot;technician/engineer&quot;,
                   18: &quot;tradesman/craftsman&quot;, 19: &quot;unemployed&quot;, 20: &quot;writer&quot;}

    # Parse movie, user, rating file
    # Here we use absolute path because the CWD may not be the directory of the current script
    # For example, in PyCharm the &quot;os.getcwd()&quot; only returns &quot;.&quot;
    root_dir = os.path.dirname(os.path.abspath(__file__)) + os.sep + &quot;ml-1m&quot;
    movie_file_path = root_dir + os.sep + &quot;movies.dat&quot;
    user_file_path = root_dir + os.sep + &quot;users.dat&quot;
    rating_file_path = root_dir + os.sep + &quot;ratings.dat&quot;
    movie_fd = open(movie_file_path)
    user_fd = open(user_file_path)
    rating_fd = open(rating_file_path)
    # To get all lines of the file, notice that each line may end with '\n', So we need &quot;rstrip&quot; function
    # Or we can get stripped lines via movie_fd.read().splitlines()
    # see also http://stackoverflow.com/questions/15233340/getting-rid-of-n-when-using-readlines
    movie_lines = movie_fd.readlines()
    user_lines = user_fd.readlines()
    rating_lines = rating_fd.readlines()

    for line in movie_lines:
        # The structure of movie files is &quot;MovieID::Title::Genres&quot;
        (movie_id, title, genres) = line.rstrip().split(&quot;::&quot;)
        movie_dict[movie_id] = Movie(movie_id, title, genres)
    for line in user_lines:
        # The structure of user files is &quot;UserID::Gender::Age::Occupation::Zipcode&quot;
        (user_id, gender, age, occupation, zipcode) = line.rstrip().split(&quot;::&quot;)
        user_dict[user_id] = User(user_id, gender, age, occupation, zipcode)
    for line in rating_lines:
        # The structure of movie files is &quot;UserID::MovieID::Rating::Timestamp&quot;
        (user_id, movie_id, rating, timestamp) = line.rstrip().split(&quot;::&quot;)
        rating_list.append(Rating(user_id, movie_id, rating, timestamp))

    for rating in rating_list:
        # Extract the needed information, assemble as dict and save in a list
        detailed_rating_list.append({&quot;rating&quot;: rating.rating,
                                     &quot;movie_genres&quot;: movie_dict[rating.movie_id].genres,
                                     &quot;user_gender&quot;: user_dict[rating.user_id].gender,
                                     &quot;user_age&quot;: user_dict[rating.user_id].age,
                                     &quot;user_occupation&quot;: occupations[int(user_dict[rating.user_id].occupation)],
                                     &quot;user_zipcode&quot;: user_dict[rating.user_id].zipcode})

    # Write the information to a file
    detailed_rating_fd = open(&quot;detailed_rating_list.txt&quot;, &quot;w&quot;)
    for detailed_rating in detailed_rating_list:
        detailed_rating_fd.write(&quot;{0}, {1}, {2}, {3}, {4}\n&quot;.format(
            detailed_rating[&quot;rating&quot;],
            detailed_rating[&quot;movie_genres&quot;].split(&quot;|&quot;)[0],
            detailed_rating[&quot;user_gender&quot;],
            detailed_rating[&quot;user_age&quot;],
            detailed_rating[&quot;user_occupation&quot;]))
    detailed_rating_fd.close()

if __name__ == &quot;__main__&quot;:
    main()

[/python]

**4/30/2015 更新**
顺便添加一个Ruby的版本（额，好多东西都忘了，边查边写的）

[ruby]
# Author:: Donghua Liu (liudonghua123@gmail.com)
# The following documentation need to rewrite according to RDoc convention
# There are a lot of links for refering some basics
# http://rdoc.sourceforge.net/doc/index.html
# http://blog.firsthand.ca/2010/09/ruby-rdoc-example.html
# This is movie class which contains movie_id, title, and genres fields
class Movie
  # http://ruby.about.com/od/oo/ss/Using-Attributes.htm
  # http://www.quora.com/What-are-setters-and-getters-in-Ruby
  attr_accessor :movie_id, :title, :genres

  def initialize (movie_id, title, genres)
    @movie_id = movie_id
    @title = title
    @genres = genres
  end
end

# This is user class which contains user_id, gender, age, occupation and zipcode fields
class User
  attr_accessor :user_id, :gender, :age, :occupation, :zipcode

  def initialize (user_id, gender, age, occupation, zipcode)
    @user_id = user_id
    @gender = gender
    @age = age
    @occupation = occupation
    @zipcode = zipcode
  end
end

# This is movie class which contains user_id, movie_id, rating and timestamp fields
class Rating
  attr_accessor :user_id, :movie_id, :rating, :timestamp

  def initialize (user_id, movie_id, rating, timestamp)
    @user_id = user_id
    @movie_id = movie_id
    @rating = rating
    @timestamp = timestamp
  end
end

def main
  # define movie, user and rating storage
  # http://rubyquicktips.com/post/603292403/accessing-a-hash-with-either-string-or-symbol-keys
  require 'active_support/hash_with_indifferent_access' # HashWithIndifferentAccess.new
  movie_dict = {}
  user_dict = {}
  rating_list = []
  detailed_rating_list = []
  occupations = {0 =&gt; 'other', 1 =&gt; 'academic/educator', 2 =&gt; 'artist', 3 =&gt; 'clerical/admin', 4 =&gt; 'college/grad student',
                 5 =&gt; 'customer service', 6 =&gt; 'doctor/health care', 7 =&gt; 'executive/managerial', 8 =&gt; 'farmer',
                 9 =&gt; 'homemaker', 10 =&gt; 'K-12 student', 11 =&gt; 'lawyer', 12 =&gt; 'programmer', 13 =&gt; 'retired',
                 14 =&gt; 'sales/marketing', 15 =&gt; 'scientist', 16 =&gt; 'self-employed', 17 =&gt; 'technician/engineer',
                 18 =&gt; 'tradesman/craftsman', 19 =&gt; 'unemployed', 20 =&gt; 'writer'}

  root_dir = 'ml-1m'
  # http://stackoverflow.com/questions/377768/string-concatenation-and-ruby
  # http://stackoverflow.com/questions/597488/how-to-do-a-safe-join-pathname-in-ruby
  # http://ruby-doc.org/core-2.1.2/File.html
  movie_file_path = File.join(root_dir, 'movies.dat')
  user_file_path = File.join(root_dir, 'users.dat')
  rating_file_path =File.join(root_dir, 'ratings.dat')

  # http://stackoverflow.com/questions/6012930/read-lines-of-a-file-in-ruby
  File.readlines(movie_file_path).each do |line|
    # The structure of movie files is &quot;MovieID::Title::Genres&quot;
    splitted_fields = line.split('::')
    movie = Movie.new(splitted_fields[0], splitted_fields[1], splitted_fields[2])
    movie_dict[splitted_fields[0]] = movie
  end
  File.readlines(user_file_path).each do |line|
    # The structure of user files is &quot;UserID::Gender::Age::Occupation::Zipcode&quot;
    splitted_fields = line.split('::')
    user = User.new(splitted_fields[0], splitted_fields[1], splitted_fields[2], splitted_fields[3], splitted_fields[4])
    user_dict[splitted_fields[0]] = user
  end
  File.readlines(rating_file_path).each do |line|
    # The structure of movie files is &quot;UserID::MovieID::Rating::Timestamp&quot;
    splitted_fields = line.split('::')
    rating = Rating.new(splitted_fields[0], splitted_fields[1], splitted_fields[2], splitted_fields[3])
    rating_list.push rating
  end

  rating_list.each do |rating|
    detailed_rating_list.push({'rating' =&gt; rating.rating,
                               'movie_genres' =&gt; movie_dict[rating.movie_id].genres,
                               'user_gender' =&gt; user_dict[rating.user_id].gender,
                               'user_age' =&gt; user_dict[rating.user_id].age,
                               'user_occupation' =&gt; occupations[user_dict[rating.user_id].occupation.to_i],
                               'user_zipcode' =&gt; user_dict[rating.user_id].zipcode})
  end

  # http://stackoverflow.com/questions/2777802/how-to-write-to-file-in-ruby
  File.open('detailed_rating_list.txt', 'w') { |detailed_rating_fd|
    detailed_rating_list.each { |detailed_rating|
      detailed_rating_fd.write(&quot;#{detailed_rating['rating']},#{detailed_rating['movie_genres'].split('|')[0]},#{detailed_rating['user_gender']},#{detailed_rating['user_age']},#{detailed_rating['user_occupation']}\n&quot;)
    }
  }

end

main

[/ruby]

参考资料
1\. [To Ruby From Python](https://www.ruby-lang.org/en/documentation/ruby-from-other-languages/to-ruby-from-python/)